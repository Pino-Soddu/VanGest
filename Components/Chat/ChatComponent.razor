@namespace VanGest.Server.Components.Chat
@using Microsoft.AspNetCore.Components
@using VanGest.Server.Services
@using VanGest.Server.Services.Vans
@using VanGest.Server.Models
@using VanGest.Server.Models.Filters
@using VanGest.Enums
@inject IDeepSeekService DeepSeekService
@inject IHttpClientFactory httpClientFactory
@inject IJSRuntime JSRuntime
@inject ILogger<ChatComponent> logger
@inject IContextService ContextService
@inject IVanService VanService
@implements IDisposable

@* ======================================================= *@
@* Mantiene TUTTA la logica originale di VanGest           *@
@* ======================================================= *@

@if (IsVisible)
{
    <div class="chat-overlay" @onclick="CloseChat">
        <div class="chat-container" @onclick:stopPropagation="true">

            <!-- HEADER - Stile CNP -->
            <div class="chat-header">
                <div class="chat-header-title">
                    <i class="fas fa-comments me-2"></i>
                    <span>Assistente Partner Sat</span>
                </div>
                <button class="chat-close-btn" @onclick="CloseChat">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- BODY - Contenuto originale -->
            <div class="chat-body">
                @foreach (var msg in conversation)
                {
                    <div class="message @(msg.IsUserMessage ? "user-message" : "ai-message")">
                        @if (msg.IsUserMessage)
                        {
                            <div class="message-content">
                                @msg.Content
                            </div>
                        }
                        else
                        {
                            <div class="ai-response">
                                @if (!string.IsNullOrWhiteSpace(msg.Content))
                                {
                                    <div class="message-content">
                                        @msg.Content
                                    </div>
                                }

                                @if (msg.Vans != null && !msg.IsStaffMode)
                                {
                                    <CustomerChatBlock Vans="msg.Vans" />
                                }
                            </div>
                        }
                    </div>
                }
            </div>

            <!-- FOOTER - Input originale -->
            <div class="chat-footer">
                <div class="chat-input-container">
                    <textarea @ref="chatInputRef"
                              @bind="userInput"
                              @bind:event="oninput"
                              @onkeydown="@(async e => await HandleEnterKey(e))"
                              placeholder="Scrivi la tua richiesta..."
                              disabled="@isLoading"
                              class="chat-input"
                              rows="1"></textarea>
                    <button @onclick="SendRequest"
                            disabled="@isLoading"
                            class="chat-send-btn">
                        @if (isLoading)
                        {
                            <span class="spinner"></span>
                            <span>Elaborazione...</span>
                        }
                        else
                        {
                            <i class="fas fa-paper-plane"></i>
                        }
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    // ================================================
    // CODICE ORIGINALE COMPLETAMENTE PRESERVATO
    // SOLO AGGIUNTE: IsVisible e CloseChat
    // ================================================

    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }

    // Variabili originali
    private string userInput = string.Empty;
    private bool isLoading = false;
    private List<ChatMessage> conversation = new();
    private bool _isDisposed;
    private ElementReference chatInputRef;
    [Parameter] public bool IsStaffMode { get; set; }

    // Metodo per chiudere la chat
    private async Task CloseChat()
    {
        await IsVisibleChanged.InvokeAsync(false);
    }

    // Metodi originali (completamente invariati)
    protected override void OnInitialized()
    {
        if (ContextService != null)
        {
            ContextService.OnContestoCambiato += HandleContestoChanged;
        }
    }

    private void HandleContestoChanged()
    {
        if (!_isDisposed)
        {
            StateHasChanged();
        }
    }

    public void Dispose()
    {
        if (!_isDisposed && ContextService != null)
        {
            ContextService.OnContestoCambiato -= HandleContestoChanged;
            _isDisposed = true;
        }
    }

    private async Task HandleEnterKey(KeyboardEventArgs e)
    {
        // Se preme Enter SENZA Shift e non sta caricando
        if (e.Key == "Enter" && !e.ShiftKey && !isLoading)
        {
            // Se c'è testo, invia
            if (!string.IsNullOrWhiteSpace(userInput))
            {
                await SendRequest();

                // Rimetti il focus dopo 100ms
                await Task.Delay(100);
                await chatInputRef.FocusAsync();
            }
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        await base.OnParametersSetAsync();

        // Aggiungi messaggio di benvenuto solo quando:
        // 1. La chat è visibile (IsVisible = true)
        // 2. La conversazione è vuota (prima apertura)
        // 3. Non siamo in modalità Staff
        if (IsVisible && conversation.Count == 0 && !IsStaffMode)
        {
            conversation.Add(new ChatMessage
            {
                Content = "Buongiorno! Sono l'Assistente Virtuale di Partner Sat, specializzato nel noleggio furgoni.\nPosso aiutarti a:\n✅ Capire quale furgone fa per te (dimensioni, tipo di utilizzo)\n✅ Darti tutte le informazioni su documenti, assicurazioni e condizioni\n✅ Mostrarti la disponibilità in tempo reale\n✅ Creare un preventivo personalizzato\n\nCome posso aiutarti oggi?",
                IsUserMessage = false
            });

            // Forza aggiornamento UI
            await InvokeAsync(StateHasChanged);

            // Metti il focus sull'input dopo che la chat è visibile
            await Task.Delay(300); // Aspetta che l'animazione finisca
            if (IsVisible)
            {
                await chatInputRef.FocusAsync();
            }
        }
    }

    private async Task SendRequest()
    {
        if (string.IsNullOrWhiteSpace(userInput) || isLoading)
            return;

        // Salva l'input prima di cancellarlo
        var request = userInput.Trim();

        isLoading = true;

        // 1. Aggiungi messaggio utente alla conversazione
        conversation.Add(new ChatMessage
        {
            Content = request,
            IsUserMessage = true
        });

        // 2. Pulisci l'input (ma mantieni il focus)
        userInput = "";

        // 3. Aggiorna UI
        await InvokeAsync(StateHasChanged);
        await ScrollToBottom();

        try
        {
            var contesto = ContextService?.ContestoAttuale ?? ContestoApplicativo.ClientiInfo;

            // =====================================================
            // AREA CLIENTI (ClientiInfo E ClientiPrenotazione)
            // =====================================================
            if (contesto == ContestoApplicativo.ClientiInfo || contesto == ContestoApplicativo.ClientiPrenotazione)
            {
                // 1. Ottieni risposta unificata
                var risposta = await DeepSeekService.GetRispostaUnificataAsync(request, contesto);

                // 2. Pulisci eventuali asterischi dal testo
                var testoPulito = risposta.RispostaTesto?.Replace("**", "") ?? string.Empty;

                // 3. Gestisci transizione se DeepSeek la richiede
                if (risposta.Tipo?.ToLower() == "ricerca" && contesto == ContestoApplicativo.ClientiInfo)
                {
                    // Cambia contesto per le prossime richieste
                    if (ContextService != null)
                    {
                        ContextService.ContestoAttuale = ContestoApplicativo.ClientiPrenotazione;
                    }

                    // Aggiungi nota sulla transizione
                    testoPulito += "\n\n✅ *Passo alla ricerca disponibilità...*";
                }

                // 4. Gestisci transizione inversa (prenota → info)
                if (risposta.Tipo?.ToLower() == "info" && contesto == ContestoApplicativo.ClientiPrenotazione)
                {
                    // Torna a ClientiInfo
                    if (ContextService != null)
                    {
                        ContextService.ContestoAttuale = ContestoApplicativo.ClientiInfo;
                    }

                    // Aggiungi nota sulla transizione
                    testoPulito += "\n\nℹ️ *Torno alle informazioni generali*";
                }

                // 5. Cerca nel database SOLO se:
                //    - È una ricerca
                //    - E ci sono filtri validi
                List<Van> vans = new();
                if (risposta.Tipo?.ToLower() == "ricerca" &&
                    risposta.Filtri != null &&
                    risposta.Filtri.HasFilters())
                {
                    vans = await VanService.GetVansAsync(risposta.Filtri);

                    if (vans.Any())
                    {
                        var count = vans.Count;
                        var brands = vans.GroupBy(v => v.Marca)
                                        .Select(g => $"{g.Count()} {g.Key}")
                                        .ToList();

                        testoPulito += $"\n\n✅ **Ho trovato {count} furgoni disponibili!**";
                        testoPulito += $"\n📊 *Distribuzione per marca:* {string.Join(", ", brands)}";
                    }
                    else
                    {
                        testoPulito += "\n\n⚠️ **Nessun furgone disponibile con questi criteri.**";
                    }
                }
                // Se non è ricerca o non ci sono filtri, NON cercare nel database

                // 6. Aggiungi alla conversazione
                conversation.Add(new ChatMessage
                {
                    Content = testoPulito,
                    IsUserMessage = false,
                    Vans = vans.Any() ? vans : null
                });
            }
            // =====================================================
            // AREA STAFF (rimane invariato)
            // =====================================================
            else
            {
                // Mantieni logica staff esistente
                var result = await DeepSeekService.AnalyzeRequestAsync(request, contesto);
                List<Van> vans = new();

                if (result.Filters is VanFilter filter)
                {
                    vans = await VanService.GetVansAsync(filter);

                    if (vans.Any())
                    {
                        conversation.Add(new ChatMessage
                        {
                            Content = result.Answer,
                            IsUserMessage = false,
                            Vans = contesto == ContestoApplicativo.ClientiPrenotazione ? vans : null,
                            ARVans = null
                        });
                    }
                    else
                    {
                        var suggestion = await DeepSeekService.GetNoResultsSuggestionAsync(filter);
                        conversation.Add(new ChatMessage
                        {
                            Content = suggestion,
                            IsUserMessage = false,
                            Vans = null
                        });
                    }
                }
            }
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Errore durante l'elaborazione");
            conversation.Add(new ChatMessage
            {
                Content = "Errore durante l'elaborazione. Riprova più tardi.",
                IsUserMessage = false
            });
        }
        finally
        {
            isLoading = false;
            await InvokeAsync(StateHasChanged);
            await ScrollToBottom();
        }
    }

    private async Task ScrollToBottom()
    {
        await Task.Delay(50); // Aspetta che l'UI si aggiorni
        await JSRuntime.InvokeVoidAsync("scrollChatToBottom");
    }

    private string BuildQueryString(object? filters)
    {
        if (filters == null) return string.Empty;

        var parameters = new List<string>();
        foreach (var prop in filters.GetType().GetProperties())
        {
            var value = prop.GetValue(filters);
            if (value != null && !string.IsNullOrEmpty(value.ToString()))
                parameters.Add($"{prop.Name}={Uri.EscapeDataString(value.ToString()!)}");
        }
        return string.Join("&", parameters);
    }

    // Metodo per gestire i risultati dei filtri avanzati (solo Staff)
    public void HandleAdvancedFilterResults(List<ARVan> arVans, List<string> visibleColumns)
    {
        conversation.Add(new ChatMessage
        {
            Content = $"🔍 {arVans.Count} veicoli trovati",
            IsCompactGrid = true,
            IsStaffMode = true,
            VisibleColumns = visibleColumns,
            ARVans = arVans,
            MessageId = conversation.Count + 1
        });
        StateHasChanged();
    }

    private void HandleDeleteResult(int messageId)
    {
        var messageToRemove = conversation.FirstOrDefault(m => m.MessageId == messageId);
        if (messageToRemove != null)
        {
            conversation.Remove(messageToRemove);
            StateHasChanged();
        }
    }

    // Classe ChatMessage originale
    private class ChatMessage
    {
        public string Content { get; set; } = string.Empty;
        public bool IsUserMessage { get; set; }
        public object? Filters { get; set; }
        public List<Van>? Vans { get; set; }
        public bool IsStaffMode { get; set; }
        public bool IsCompactGrid { get; set; }
        public List<string>? VisibleColumns { get; set; }
        public List<ARVan>? ARVans { get; set; }
        public int MessageId { get; set; }
    }
}