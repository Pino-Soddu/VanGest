@namespace VanGest.Server.Components.Staff.Map
@using VanGest.Server.Services
@inject ModalService ModalService
@inject IJSRuntime JSRuntime
@implements IDisposable

<!-- Aggiunto wrapper esterno -->
<div style="position: relative; width: 100%; height: 96vh; min-height: 500px;">
    <div id="google-maps-container" style="height: 98%; width: 100%; border: 2px solid gray;"></div>

    <!-- Icona posizionata FUORI dal container della mappa -->
    <button @onclick="NavigateToFilters"
    style="position: absolute; top: 10px; right: 10px; z-index: 1000;
                  background: white; border: none; border-radius: 2px;
                  padding: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.3);
                  cursor: pointer;">
        <img src="/icons/filter.svg" style="width: 24px; height: 24px; display: block;" />
    </button>
</div>

@code {
    [Parameter] public List<ARVan> Vans { get; set; } = new();
    [Parameter] public EventCallback<List<ARVan>> OnMarkersUpdated { get; set; }

    //private ElementReference _mapContainer;
    private DotNetObjectReference<GoogleMapsOverlay>? _dotNetRef;
    private bool _isFirstLoad = true;
    private const string MapContainerId = "google-maps-container";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _dotNetRef = DotNetObjectReference.Create(this);
            await LoadGoogleMaps();
            _isFirstLoad = false;
        }

        await UpdateMap();
    }

    protected override async Task OnParametersSetAsync()
    {
        if (!_isFirstLoad)
        {
            await UpdateMap();
        }
    }

    private async Task LoadGoogleMaps()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("loadGoogleMaps");
            await Task.Delay(100); // Buffer per il caricamento API
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Errore caricamento Google Maps: {ex.Message}");
        }
    }

    private async Task UpdateMap()
    {
        if (Vans?.Any() != true) return;

        try
        {
            var validVans = Vans.Where(v =>
                v.Latitudine != 0 &&
                v.Longitudine != 0)
                .ToList();

            await JSRuntime.InvokeVoidAsync(
                "initGoogleMap",
                MapContainerId,
                validVans
            );

            await OnMarkersUpdated.InvokeAsync(validVans);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Errore aggiornamento mappa: {ex.Message}");
        }
    }

    private async Task NavigateToFilters()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("vanGest.utils.scrollToFilters");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Errore durante lo scroll: {ex.Message}");
        }
    }

    public static void Show(ModalService modalService, List<ARVan> vans)
    {
        modalService.Close();
        var options = new ModalService.ModalOptions { Fullscreen = true };

        var content = new RenderFragment(builder =>
        {
            builder.OpenComponent<GoogleMapsOverlay>(0);
            builder.AddAttribute(1, "Vans", vans);
            builder.CloseComponent();
        });

        modalService.OnClose += () => { /* Cleanup opzionale */ };
        modalService.Show("Mappa Furgoni", content, options);
    }

    public void Dispose()
    {
        try
        {
            _dotNetRef?.Dispose();
            JSRuntime.InvokeVoidAsync("vanGest.maps.google.reset");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Errore durante il dispose: {ex.Message}");
        }
    }
}