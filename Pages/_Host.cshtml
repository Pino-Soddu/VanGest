@page "/"
@using Microsoft.AspNetCore.Components.Web
@namespace VanGest.Server.Pages
@addTagHelper *, Microsoft.AspNetCorxe.Mvc.TagHelpers

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <base href="~/" />
    <link href="~/css/app.css" rel="stylesheet" />
	<link href="VanGest.Server.styles.css" rel="stylesheet" />
    <link rel="stylesheet" href="/css/map-styles.css">

    <!-- Aggiungi questi riferimenti per Leaflet/OSM -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
          crossorigin="" />

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
          integrity="sha512-1ycn6IcaQQ40/MKBW2W4Rhis/xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
          crossorigin="anonymous"
          referrerpolicy="no-referrer" />

    <component type="typeof(HeadOutlet)" render-mode="ServerPrerendered" />
    <script src="js/map-init.js?v=@DateTime.Now.Ticks"></script>
    <script>
        window.openInNewTab = function(base64Data, mimeType) {
            const blob = b64toBlob(base64Data, mimeType);
            const url = URL.createObjectURL(blob);
            window.open(url, '_blank');
            URL.revokeObjectURL(url); // Libera memoria dopo l'apertura
        };

        function b64toBlob(b64Data, contentType) {
            const byteCharacters = atob(b64Data);
            const byteArrays = [];
            for (let offset = 0; offset < byteCharacters.length; offset += 512) {
                const slice = byteCharacters.slice(offset, offset + 512);
                const byteNumbers = new Array(slice.length);
                for (let i = 0; i < slice.length; i++) {
                    byteNumbers[i] = slice.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                byteArrays.push(byteArray);
            }
            return new Blob(byteArrays, { type: contentType });
        }
    </script>

</head>
<body>
    <component type="typeof(App)" render-mode="ServerPrerendered" />

    <div id="blazor-error-ui">
        <environment include="Staging,Production">
            An error has occurred. This application may no longer respond until reloaded.
        </environment>
        <environment include="Development">
            An unhandled exception has occurred. See browser dev tools for details.
        </environment>
        <a href="" class="reload">Reload</a>
        <a class="dismiss">🗙</a>
    </div>

    <script src="_framework/blazor.server.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-xxxxxxxxxxxxxxxxxxxxxxxxxx"
            crossorigin=""></script>
    <script src="https://unpkg.com/@@googlemaps/markerclusterer/dist/index.min.js"></script>
    <script src="js/interop.js"></script>
    <script src="js/map-init.js"></script> <!-- Aggiunto riferimento al tuo file JS della mappa -->

    <script>
        // Blazor JS Utilities - Versione Ottimizzata
        window.blazorHelpers = {
            // Ricarica la pagina corrente
            reloadPage: () => window.location.reload(true),

            // Apertura nuova scheda con controllo errori
            openNewTab: (url, target = '_blank') => {
                try {
                    const newWindow = window.open(url, target);
                    if (!newWindow || newWindow.closed || typeof newWindow.closed === 'undefined') {
                        console.warn('Popup bloccato dal browser, apro nella stessa scheda');
                        window.location.href = url;
                    }
                    return newWindow;
                } catch (e) {
                    console.error('Errore apertura nuova scheda:', e);
                    window.location.href = url;
                }
            },

            // Rilevamento viewport mobile
            isMobileViewport: () => window.matchMedia("(max-width: 991px)").matches,

            // Focus su finestra esistente
            focusWindow: (targetWindowName) => {
                const target = window.open('', targetWindowName);
                if (target) target.focus();
            }
        };
    </script>


    <script>
        window.loadGoogleMaps = () => {
            if (window.google?.maps?.Map) {
                console.log("[Google Maps] API già disponibile");
                return Promise.resolve();
            }

            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://maps.googleapis.com/maps/api/js?key=xxxxxxxxxxxxxxxxxxxxxxxxxx&loading=async';
                script.async = true;
                script.defer = true;

                script.onload = () => {
                    console.log("[Google Maps] API pronta");
                    resolve();
                };
                script.onerror = (err) => {
                    console.error("[Google Maps] Errore caricamento:", err);
                    reject(err);
                };

                document.head.appendChild(script);
            });
        };
    </script>
    
</body>

</html>

